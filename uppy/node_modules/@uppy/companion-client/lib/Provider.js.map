{"version":3,"names":["_classPrivateFieldLooseBase","receiver","privateKey","Object","prototype","hasOwnProperty","call","TypeError","id","_classPrivateFieldLooseKey","name","RequestClient","tokenStorage","getName","split","map","s","charAt","toUpperCase","slice","join","getOrigin","location","origin","getRegex","value","RegExp","undefined","isOriginAllowed","allowedOrigin","patterns","Array","isArray","some","pattern","test","_refreshingTokenPromise","_getAuthToken","_removeAuthToken","Provider","constructor","uppy","opts","defineProperty","_removeAuthToken2","_getAuthToken2","writable","provider","pluginId","tokenKey","companionKeysParams","preAuthToken","headers","token","Promise","all","authHeaders","btoa","JSON","stringify","params","onReceiveResponse","response","plugin","getPlugin","oldAuthenticated","getPluginState","authenticated","status","setPluginState","setAuthToken","storage","setItem","ensurePreAuth","fetchPreAuthToken","Error","authUrl","queries","URLSearchParams","state","set","hostname","login","resolve","reject","link","authWindow","window","open","handleToken","e","source","log","warn","companionAllowedHosts","data","parse","error","message","i18n","info","close","removeEventListener","addEventListener","refreshTokenUrl","fileUrl","request","arguments","err","isAuthError","path","method","uppyAuthToken","res","post","list","directory","options","get","logout","initPlugin","defaultOpts","type","files","serverUrl","serverPattern","companionUrl","replace","URL","getItem","removeItem"],"sources":["Provider.js"],"sourcesContent":["'use strict'\n\nimport RequestClient from './RequestClient.js'\nimport * as tokenStorage from './tokenStorage.js'\n\nconst getName = (id) => {\n  return id.split('-').map((s) => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')\n}\n\nfunction getOrigin () {\n  // eslint-disable-next-line no-restricted-globals\n  return location.origin\n}\n\nfunction getRegex (value) {\n  if (typeof value === 'string') {\n    return new RegExp(`^${value}$`)\n  } if (value instanceof RegExp) {\n    return value\n  }\n  return undefined\n}\n\nfunction isOriginAllowed (origin, allowedOrigin) {\n  const patterns = Array.isArray(allowedOrigin) ? allowedOrigin.map(getRegex) : [getRegex(allowedOrigin)]\n  return patterns\n    .some((pattern) => pattern?.test(origin) || pattern?.test(`${origin}/`)) // allowing for trailing '/'\n}\n\nexport default class Provider extends RequestClient {\n  #refreshingTokenPromise\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.provider = opts.provider\n    this.id = this.provider\n    this.name = this.opts.name || getName(this.id)\n    this.pluginId = this.opts.pluginId\n    this.tokenKey = `companion-${this.pluginId}-auth-token`\n    this.companionKeysParams = this.opts.companionKeysParams\n    this.preAuthToken = null\n  }\n\n  async headers () {\n    const [headers, token] = await Promise.all([super.headers(), this.#getAuthToken()])\n    const authHeaders = {}\n    if (token) {\n      authHeaders['uppy-auth-token'] = token\n    }\n\n    if (this.companionKeysParams) {\n      authHeaders['uppy-credentials-params'] = btoa(\n        JSON.stringify({ params: this.companionKeysParams }),\n      )\n    }\n    return { ...headers, ...authHeaders }\n  }\n\n  onReceiveResponse (response) {\n    super.onReceiveResponse(response)\n    const plugin = this.uppy.getPlugin(this.pluginId)\n    const oldAuthenticated = plugin.getPluginState().authenticated\n    const authenticated = oldAuthenticated ? response.status !== 401 : response.status < 400\n    plugin.setPluginState({ authenticated })\n    return response\n  }\n\n  async setAuthToken (token) {\n    return this.uppy.getPlugin(this.pluginId).storage.setItem(this.tokenKey, token)\n  }\n\n  async #getAuthToken () {\n    return this.uppy.getPlugin(this.pluginId).storage.getItem(this.tokenKey)\n  }\n\n  async #removeAuthToken () {\n    return this.uppy.getPlugin(this.pluginId).storage.removeItem(this.tokenKey)\n  }\n\n  /**\n   * Ensure we have a preauth token if necessary. Attempts to fetch one if we don't,\n   * or rejects if loading one fails.\n   */\n  async ensurePreAuth () {\n    if (this.companionKeysParams && !this.preAuthToken) {\n      await this.fetchPreAuthToken()\n\n      if (!this.preAuthToken) {\n        throw new Error('Could not load authentication data required for third-party login. Please try again later.')\n      }\n    }\n  }\n\n  authUrl (queries = {}) {\n    const params = new URLSearchParams({\n      state: btoa(JSON.stringify({ origin: getOrigin() })),\n      ...queries,\n    })\n    if (this.preAuthToken) {\n      params.set('uppyPreAuthToken', this.preAuthToken)\n    }\n\n    return `${this.hostname}/${this.id}/connect?${params}`\n  }\n\n  async login (queries) {\n    await this.ensurePreAuth()\n\n    return new Promise((resolve, reject) => {\n      const link = this.authUrl(queries)\n      const authWindow = window.open(link, '_blank')\n      const handleToken = (e) => {\n        if (e.source !== authWindow) {\n          this.uppy.log.warn('ignoring event from unknown source', e)\n          return\n        }\n\n        const { companionAllowedHosts } = this.uppy.getPlugin(this.pluginId).opts\n        if (!isOriginAllowed(e.origin, companionAllowedHosts)) {\n          reject(new Error(`rejecting event from ${e.origin} vs allowed pattern ${companionAllowedHosts}`))\n          return\n        }\n\n        // Check if it's a string before doing the JSON.parse to maintain support\n        // for older Companion versions that used object references\n        const data = typeof e.data === 'string' ? JSON.parse(e.data) : e.data\n\n        if (data.error) {\n          const { uppy } = this\n          const message = uppy.i18n('authAborted')\n          uppy.info({ message }, 'warning', 5000)\n          reject(new Error('auth aborted'))\n          return\n        }\n\n        if (!data.token) {\n          reject(new Error('did not receive token from auth window'))\n          return\n        }\n\n        authWindow.close()\n        window.removeEventListener('message', handleToken)\n        this.setAuthToken(data.token)\n        resolve()\n      }\n      window.addEventListener('message', handleToken)\n    })\n  }\n\n  refreshTokenUrl () {\n    return `${this.hostname}/${this.id}/refresh-token`\n  }\n\n  fileUrl (id) {\n    return `${this.hostname}/${this.id}/get/${id}`\n  }\n\n  /** @protected */\n  async request (...args) {\n    await this.#refreshingTokenPromise\n\n    try {\n      // throw Object.assign(new Error(), { isAuthError: true }) // testing simulate access token expired (to refresh token)\n      return await super.request(...args)\n    } catch (err) {\n      if (!err.isAuthError) throw err // only handle auth errors (401 from provider)\n\n      await this.#refreshingTokenPromise\n\n      // Many provider requests may be starting at once, however refresh token should only be called once.\n      // Once a refresh token operation has started, we need all other request to wait for this operation (atomically)\n      this.#refreshingTokenPromise = (async () => {\n        try {\n          const response = await super.request({ path: this.refreshTokenUrl(), method: 'POST' })\n          await this.setAuthToken(response.uppyAuthToken)\n        } finally {\n          this.#refreshingTokenPromise = undefined\n        }\n      })()\n\n      await this.#refreshingTokenPromise\n\n      // now retry the request with our new refresh token\n      return super.request(...args)\n    }\n  }\n\n  async fetchPreAuthToken () {\n    if (!this.companionKeysParams) {\n      return\n    }\n\n    try {\n      const res = await this.post(`${this.id}/preauth/`, { params: this.companionKeysParams })\n      this.preAuthToken = res.token\n    } catch (err) {\n      this.uppy.log(`[CompanionClient] unable to fetch preAuthToken ${err}`, 'warning')\n    }\n  }\n\n  list (directory, options) {\n    return this.get(`${this.id}/list/${directory || ''}`, options)\n  }\n\n  async logout (options) {\n    const response = await this.get(`${this.id}/logout`, options)\n    await this.#removeAuthToken()\n    return response\n  }\n\n  static initPlugin (plugin, opts, defaultOpts) {\n    /* eslint-disable no-param-reassign */\n    plugin.type = 'acquirer'\n    plugin.files = []\n    if (defaultOpts) {\n      plugin.opts = { ...defaultOpts, ...opts }\n    }\n\n    if (opts.serverUrl || opts.serverPattern) {\n      throw new Error('`serverUrl` and `serverPattern` have been renamed to `companionUrl` and `companionAllowedHosts` respectively in the 0.30.5 release. Please consult the docs (for example, https://uppy.io/docs/instagram/ for the Instagram plugin) and use the updated options.`')\n    }\n\n    if (opts.companionAllowedHosts) {\n      const pattern = opts.companionAllowedHosts\n      // validate companionAllowedHosts param\n      if (typeof pattern !== 'string' && !Array.isArray(pattern) && !(pattern instanceof RegExp)) {\n        throw new TypeError(`${plugin.id}: the option \"companionAllowedHosts\" must be one of string, Array, RegExp`)\n      }\n      plugin.opts.companionAllowedHosts = pattern\n    } else if (/^(?!https?:\\/\\/).*$/i.test(opts.companionUrl)) {\n      // does not start with https://\n      plugin.opts.companionAllowedHosts = `https://${opts.companionUrl.replace(/^\\/\\//, '')}`\n    } else {\n      plugin.opts.companionAllowedHosts = new URL(opts.companionUrl).origin\n    }\n\n    plugin.storage = plugin.opts.storage || tokenStorage\n    /* eslint-enable no-param-reassign */\n  }\n}\n"],"mappings":"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"}